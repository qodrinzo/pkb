function opUndo(){return $(defaultUtilsOutliner).concord().op.undo()}function opCut(){return $(defaultUtilsOutliner).concord().op.cut()}function opCopy(){return $(defaultUtilsOutliner).concord().op.copy()}function opPaste(){return $(defaultUtilsOutliner).concord().op.paste()}function opReorg(e,t){return $(defaultUtilsOutliner).concord().op.reorg(e,t)}function opSetFont(e,t,o){$(defaultUtilsOutliner).concord().prefs({outlineFont:e,outlineFontSize:t,outlineLineHeight:o})}function opPromote(){$(defaultUtilsOutliner).concord().op.promote()}function opDemote(){$(defaultUtilsOutliner).concord().op.demote()}function opBold(){return $(defaultUtilsOutliner).concord().op.bold()}function opStrikethrough(){return $(defaultUtilsOutliner).concord().op.strikethrough()}function opItalic(){return $(defaultUtilsOutliner).concord().op.italic()}function opLink(e){return $(defaultUtilsOutliner).concord().op.link(e)}function opSetTextMode(e){$(defaultUtilsOutliner).concord().op.setTextMode(e)}function opInTextMode(){return $(defaultUtilsOutliner).concord().op.inTextMode()}function opGetAtts(){return $(defaultUtilsOutliner).concord().op.attributes.getAll()}function opGetOneAtt(e){return $(defaultUtilsOutliner).concord().op.attributes.getOne(e)}function opHasAtt(e){return void 0!==opGetOneAtt(e)}function opSetOneAtt(e,t){return $(defaultUtilsOutliner).concord().op.attributes.setOne(e,t)}function opSetAtts(e){return $(defaultUtilsOutliner).concord().op.attributes.setGroup(e)}function opAddAtts(e){return $(defaultUtilsOutliner).concord().op.attributes.addGroup(e)}function opSetStyle(e){return $(defaultUtilsOutliner).concord().op.setStyle(e)}function opGetLineText(){return $(defaultUtilsOutliner).concord().op.getLineText()}function opExpand(){return $(defaultUtilsOutliner).concord().op.expand()}function opExpandAllLevels(){return $(defaultUtilsOutliner).concord().op.expandAllLevels()}function opExpandEverything(){return $(defaultUtilsOutliner).concord().op.fullExpand()}function opCollapse(){return $(defaultUtilsOutliner).concord().op.collapse()}function opIsComment(){return $(defaultUtilsOutliner).concord().script.isComment()}function opMakeComment(){return $(defaultUtilsOutliner).concord().script.makeComment()}function opUnComment(){return $(defaultUtilsOutliner).concord().script.unComment()}function opToggleComment(){opIsComment()?opUnComment():opMakeComment()}function opCollapseEverything(){return $(defaultUtilsOutliner).concord().op.fullCollapse()}function opInsert(e,t){return $(defaultUtilsOutliner).concord().op.insert(e,t)}function opInsertImage(e){return $(defaultUtilsOutliner).concord().op.insertImage(e)}function opSetLineText(e){return $(defaultUtilsOutliner).concord().op.setLineText(e)}function opDeleteSubs(){return $(defaultUtilsOutliner).concord().op.deleteSubs()}function opCountSubs(){return $(defaultUtilsOutliner).concord().op.countSubs()}function opHasSubs(){return opCountSubs()>0}function opSubsExpanded(){return $(defaultUtilsOutliner).concord().op.subsExpanded()}function opGo(e,t){return $(defaultUtilsOutliner).concord().op.go(e,t)}function opFirstSummit(){opGo(left,32767),opGo(up,32767)}function opXmlToOutline(e){return $(defaultUtilsOutliner).concord().op.xmlToOutline(e)}function opInsertXml(e,t){return $(defaultUtilsOutliner).concord().op.insertXml(e,t)}function opOutlineToXml(e,t,o){return $(defaultUtilsOutliner).concord().op.outlineToXml(e,t,o)}function opCursorToXml(){return $(defaultUtilsOutliner).concord().op.cursorToXml()}function opSetTitle(e){return $(defaultUtilsOutliner).concord().op.setTitle(e)&&$(defaultUtilsOutliner).concord().op.setId(e)}function opGetTitle(){return $(defaultUtilsOutliner).concord().op.getTitle()}function opHasChanged(){return $(defaultUtilsOutliner).concord().op.changed()}function opClearChanged(){return $(defaultUtilsOutliner).concord().op.clearChanged()}function opMarkChanged(){return $(defaultUtilsOutliner).concord().op.markChanged()}function opRedraw(){return $(defaultUtilsOutliner).concord().op.redraw()}function opVisitAll(e){return $(defaultUtilsOutliner).concord().op.visitAll(e)}function opWipe(){return $(defaultUtilsOutliner).concord().op.wipe()}function readText(e,t,o,n){var r={};void 0!==n&&n&&(r={Accept:"text/x-opml"});$.ajax({url:readHttpUrl+"?url="+encodeURIComponent(e)+"&type="+encodeURIComponent("text/plain"),dataType:"text",headers:r,timeout:3e4}).success(function(e,n){t(e,o)}).error(function(e){httpReadStatus=e})}function filledString(e,t){for(var o="",n=0;t>n;n++)o+=e;return o}function multipleReplaceAll(e,t,o,n,r){void 0===o&&(o=!1),void 0===n&&(n=""),void 0===r&&(r="");for(var i in t){var s=t[i],a="g";o||(a="gi");var c=(n+i+r).replace(/([.?*+^$[\]\\(){}|-])/g,"\\$1"),d=new RegExp(c,a);e=e.replace(d,s)}return e}function secondsSince(e){var t=new Date;return(t-e)/1e3}Array.prototype.indexOf||(Array.prototype.indexOf=function(e,t){for(var o=t||0,n=this.length;n>o;o++)if(this[o]===e)return o;return-1}),function($){function ConcordOutline(e,t){this.container=e,this.options=t,this.id=null,this.root=null,this.pasteBin=null,this.editor=null,this.op=null,this.script=null,this.init=function(){if($(e).find(".concord-root:first").length>0)return this.root=$(e).find(".concord-root:first"),this.pasteBin=$(e).find(".pasteBin:first"),void this.afterInit();var t=$("<ol></ol>");t.addClass("concord concord-root"),t.appendTo(e),this.root=t;var o=$('<div class="pasteBin" contenteditable="true" style="position: absolute; height: 1px; width:1px; outline:none; overflow:hidden;"></div>');o.appendTo(e),this.pasteBin=o,this.afterInit(),this.events=new ConcordEvents(this.root,this.editor,this.op,this)},this.afterInit=function(){this.editor=new ConcordEditor(this.root,this),this.op=new ConcordOp(this.root,this),this.script=new ConcordScript(this.root,this),t&&(t.prefs&&this.prefs(t.prefs),t.open&&this.root.data("open",t.open),t.save&&this.root.data("save",t.save),t.callbacks&&this.callbacks(t.callbacks),t.id&&(this.root.data("id",t.id),this.open(t.callbacks.cbOpen)))},this.pasteBinFocus=function(){if(concord.ready&&!concord.mobile&&this.root.is(":visible")){var e=this.op.getCursor(),t=e.offset();this.pasteBin.offset(t),this.pasteBin.css("z-index","1000"),(""===this.pasteBin.text()||"\n"==this.pasteBin.text())&&this.pasteBin.text("..."),this.op.focusCursor(),this.pasteBin.focus(),this.pasteBin[0]===document.activeElement&&document.execCommand("selectAll")}},this.callbacks=function(e){return e?(this.root.data("callbacks",e),e):this.root.data("callbacks")?this.root.data("callbacks"):{}},this.fireCallback=function(e,t){var o=this.callbacks()[e];o&&o(t)},this.prefs=function(e){var t=this.root.data("prefs");if(void 0===t&&(t={}),e){for(var o in e)t[o]=e[o];this.root.data("prefs",t),t.readonly&&this.root.addClass("readonly"),void 0!==t.renderMode&&this.root.data("renderMode",t.renderMode),t.contextMenu&&$(t.contextMenu).hide();var n={};t.outlineFont&&(n["font-family"]=t.outlineFont),t.outlineFontSize&&(t.outlineFontSize=parseInt(t.outlineFontSize),n["font-size"]=t.outlineFontSize+"px",n["min-height"]=t.outlineFontSize+6+"px",n["line-height"]=t.outlineFontSize+6+"px"),t.outlineLineHeight&&(t.outlineLineHeight=parseInt(t.outlineLineHeight),n["min-height"]=t.outlineLineHeight+"px",n["line-height"]=t.outlineLineHeight+"px"),this.root.parent().find("style.prefsStyle").remove();var r='<style type="text/css" class="prefsStyle">\n',i="";this.root.parent().attr("id")&&(i="#"+this.root.parent().attr("id")),r+=i+" .concord .concord-node .concord-wrapper .concord-text {";var s;for(s in n)r+=s+": "+n[s]+";";r+="}\n",r+=i+" .concord .concord-node .concord-wrapper .node-icon {";for(s in n)"font-family"!=s&&(r+=s+": "+n[s]+";");r+="}\n";var a=t.outlineLineHeight;void 0===a&&(a=t.outlineFontSize),void 0!==a&&(r+=i+" .concord .concord-node .concord-wrapper {",r+="padding-left: "+a+"px",r+="}\n",r+=i+" .concord ol {",r+="padding-left: "+a+"px",r+="}\n"),r+="</style>\n",this.root.before(r),e.css&&this.op.setStyle(e.css)}return t},this["new"]=function(){this.op.wipe()},this.open=function(e){var t=this.root.data("id");if(t){var o=this.root,n=(this.editor,this.op),r="http://concord.smallpicture.com/open";o.data("open")&&(r=o.data("open")),params={},t.match(/^http.+$/)?params.url=t:params.id=t,$.ajax({type:"POST",url:r,data:params,dataType:"xml",success:function(t){t&&(n.xmlToOutline(t),e&&e())},error:function(){0===o.find(".concord-node").length&&n.wipe()}})}},this.save=function(e){var t;if(t=this.root.data("id"),!t.match(/[\\/*?:"<>|]/)&&t&&this.op.changed()){var o="http://concord.smallpicture.com/save";this.root.data("save")&&(o=this.root.data("save"));var n=this,r=this.op.outlineToXml();$.ajax({type:"POST",url:o,data:{opml:r,id:t},dataType:"json",success:function(t){n.op.clearChanged(),e&&e(t)}})}},this["import"]=function(e,t){var o="http://concordold.smallpicture.com/open",n=this.root,r=this;n.data("open")&&(o=n.data("open")),params={},e.match(/^http.+$/)?params.url=e:params.id=e,$.ajax({type:"POST",url:o,data:params,dataType:"xml",success:function(e){if(e){var o=n.find(".concord-cursor:first");$(e).find("body").children("outline").each(function(){var e=r.editor.build($(this));o.after(e),o=e}),r.op.markChanged(),t&&t()}},error:function(){}})},this["export"]=function(){var e=this.root.find(".concord-cursor:first");return 0===e.length&&(e=this.root.find(".concord-root:first")),this.editor.opml(e)},this.init()}function ConcordEditor(e,t){this.makeNode=function(){var e=$("<li></li>");e.addClass("concord-node");var t=$("<div class='concord-wrapper'></div>"),o="caret-right",n='<i class="node-icon fa fa-'+o+'"></i>';t.append(n),t.addClass("type-icon");var r=$("<div class='concord-text' contenteditable='true'></div>"),i=$("<ol></ol>");return r.appendTo(t),t.appendTo(e),i.appendTo(e),e},this.dragMode=function(){e.data("draggingChange",e.children().clone(!0,!0)),e.addClass("dragging"),e.data("dragging",!0)},this.dragModeExit=function(){e.data("dragging")&&(t.op.markChanged(),e.data("change",e.data("draggingChange")),e.data("changeTextMode",!1),e.data("changeRange",void 0)),e.find(".draggable").removeClass("draggable"),e.find(".drop-sibling").removeClass("drop-sibling"),e.find(".drop-child").removeClass("drop-child"),e.removeClass("dragging"),e.data("dragging",!1),e.data("mousedown",!1)},this.edit=function(o,n){var r=o.children(".concord-wrapper:first").children(".concord-text:first");n&&r.html(""),r.focus();var i=r.get(0);if(i&&i.childNodes&&i.childNodes[0])if("undefined"!=typeof window.getSelection&&"undefined"!=typeof document.createRange){var s=document.createRange();s.selectNodeContents(i),s.collapse(!1);var a=window.getSelection();a.removeAllRanges(),a.addRange(s)}else if("undefined"!=typeof document.body.createTextRange){var c=document.body.createTextRange();c.moveToElementText(i),c.collapse(!1),c.select()}r.addClass("editing"),n||e.find(".concord-node.dirty").length>0&&t.op.markChanged()},this.editable=function(e){var t=!1;return e.hasClass("concord-text")||(e=e.parents(".concord-text:first")),1==e.length&&(t=e.hasClass("concord-text")&&e.hasClass("editing")),t},this.editorMode=function(){e.find(".selected").removeClass("selected"),e.find(".editing").each(function(){$(this).removeClass("editing")}),e.find(".selection-toolbar").remove()},this.opml=function(t,o){void 0===o&&(o=!1),t&&(e=t);var n=e.data("title");n||(n=e.hasClass("concord-node")?e.children(".concord-wrapper:first").children(".concord-text:first").text():"");var r='<?xml version="1.0" encoding="UTF-8"?>\n';if(r+='<opml version="2.0">\n',r+="<head>\n",r+="<title>"+ConcordUtil.escapeXml(n)+"</title>\n",r+="</head>\n",r+="<body>\n",e.hasClass("concord-cursor"))r+=this.opmlLine(e,0,o);else{var i=this;e.children(".concord-node").each(function(){r+=i.opmlLine($(this))})}return r+="</body>\n",r+="</opml>\n"},this.opmlLine=function(e,t,o){void 0===t&&(t=0),void 0===o&&(o=!1);var n=this.unescape(e.children(".concord-wrapper:first").children(".concord-text:first").html()),r=n.match(/^(.+)<br>\s*$/);r&&(n=r[1]);for(var i="",s=0;t>s;s++)i+="	";var a;if(o)a=e.children("ol").children(".concord-node");else{i+='<outline text="'+ConcordUtil.escapeXml(n)+'"';var c=e.data("attributes");void 0===c&&(c={});for(var d in c)void 0!==d&&""!==d&&"text"!=d&&void 0!==c[d]&&(i+=" "+d+'="'+ConcordUtil.escapeXml(c[d])+'"');if(a=e.children("ol").children(".concord-node"),0===a.length)return i+="/>\n";i+=">\n"}var l=this;if(t++,a.each(function(){i+=l.opmlLine($(this),t)}),!o){for(var s=0;t>s;s++)i+="	";i+="</outline>\n"}return i},this.textLine=function(e,t){t||(t=0);for(var o="",n=0;t>n;n++)o+="	";o+=this.unescape(e.children(".concord-wrapper:first").children(".concord-text:first").html()),o+="\n";var r=this;return e.children("ol").children(".concord-node").each(function(){o+=r.textLine($(this),t+1)}),o},this.select=function(o,n,r){if(void 0===n&&(n=!1),void 0===r&&(r=!1),1==o.length){if(this.selectionMode(n),n&&(o.parents(".concord-node.selected").removeClass("selected"),o.find(".concord-node.selected").removeClass("selected")),n&&r){var i,s=o.prevAll(".selected");if(s.length>0)i=!1,o.prevAll().reverse().each(function(){$(this).hasClass("selected")?i=!0:i&&$(this).addClass("selected")});else{var a=o.nextAll(".selected");a.length>0&&(i=!0,o.nextAll().each(function(){$(this).hasClass("selected")?i=!1:i&&$(this).addClass("selected")}))}}var c=o.children(".concord-wrapper:first").children(".concord-text:first");c.hasClass("editing")&&c.removeClass("editing"),o.addClass("selected"),c.text().length>0,this.dragModeExit()}e.find(".concord-node.dirty").length>0&&t.op.markChanged()},this.selectionMode=function(t){void 0===t&&(t=!1);var o=e.find(".concord-cursor");if(1==o.length){var n=o.children(".concord-wrapper:first").children(".concord-text:first");1==n.length}t||e.find(".selected").removeClass("selected"),e.find(".selection-toolbar").remove()},this.build=function(e,o,n){n||(n=1);var r=$("<li></li>");r.addClass("concord-node"),r.addClass("concord-level-"+n);var i={};$(e[0].attributes).each(function(){"text"!=this.name&&(i[this.name]=this.value,"type"==this.name&&r.attr("opml-"+this.name,this.value))}),r.data("attributes",i);var s=$("<div class='concord-wrapper'></div>"),a=i.icon;a||(a=i.type);var c="caret-right";a&&(a==r.attr("opml-type")&&t.prefs()&&t.prefs().typeIcons&&t.prefs().typeIcons[a]?c=t.prefs().typeIcons[a]:a==i.icon&&(c=a));var d='<i class="node-icon fa fa-'+c+'"></i>';s.append(d),s.addClass("type-icon"),"true"==i.isComment&&r.addClass("concord-comment");var l=$("<div class='concord-text' contenteditable='true'></div>");if(l.addClass("concord-level-"+n+"-text"),l.html(this.escape(e.attr("text"))),void 0!==i.cssTextClass){var h=i.cssTextClass.split(/\s+/);for(var u in h){var p=h[u];l.addClass(p)}}var f=$("<ol></ol>"),v=this;return e.children("outline").each(function(){var e=v.build($(this),o,n+1);e.appendTo(f)}),o&&e.children("outline").size()>0&&r.addClass("collapsed"),l.appendTo(s),s.appendTo(r),f.appendTo(r),r},this.hideContextMenu=function(){e.data("dropdown")&&(e.data("dropdown").hide(),e.data("dropdown").remove(),e.removeData("dropdown"))},this.showContextMenu=function(o,n){if(t.prefs().contextMenu){this.hideContextMenu(),e.data("dropdown",$(t.prefs().contextMenu).clone().appendTo(t.container));var r=this;e.data("dropdown").on("click","a",function(e){r.hideContextMenu()}),e.data("dropdown").css({position:"absolute",top:n+"px",left:o+"px",cursor:"default"}),e.data("dropdown").show()}},this.sanitize=function(){e.find(".concord-text.paste").each(function(){var o=$(this);if("..."!=t.pasteBin.text()){var n=t.pasteBin.html();n=n.replace(new RegExp("<(div|p|blockquote|pre|li|br|dd|dt|code|h\\d)[^>]*(/)?>","gi"),"\n"),n=$("<div/>").html(n).text();var r=!1;if(void 0!==concordClipboard){var i=concordClipboard.text.replace(/^[\s\r\n]+|[\s\r\n]+$/g,""),s=n.replace(/^[\s\r\n]+|[\s\r\n]+$/g,"");if(i==s){var a=concordClipboard.data;if(a){var c=function(e){e.find("ol").each(function(){$(this).children().length>0&&$(this).parent().addClass("collapsed")})};a.each(function(){c($(this))}),e.data("clipboard",a),t.op.setTextMode(!1),t.op.paste(),r=!0}}}if(!r){concordClipboard=void 0;for(var d=0,l=n.split("\n"),h=0;h<l.length;h++){var u=l[h];""===u||u.match(/^\s+$/)||d++}if(!t.op.inTextMode()||d>1)t.op.insertText(n);else{t.op.saveState(),o.focus();var p=o.parents(".concord-node:first").data("range");if(p)try{var f=window.getSelection();f.removeAllRanges(),f.addRange(p)}catch(v){console.log(v)}finally{o.parents(".concord-node:first").removeData("range")}document.execCommand("insertText",null,n),t.root.removeData("clipboard"),t.op.markChanged()}}o.removeClass("paste")}})},this.escape=function(e){var o=$("<div/>").text(e).html();if(o=o.replace(/\u00A0/g," "),t.op.getRenderMode()){var n=["b","strong","i","em","a","img","strike","del"];for(var r in n){var i=n[r];o="img"==i?o.replace(new RegExp("&lt;"+i+"((?!&gt;).+)(/)?&gt;","gi"),"<"+i+"$1/>"):"a"==i?o.replace(new RegExp("&lt;"+i+"((?!&gt;).*?)&gt;((?!&lt;/"+i+"&gt;).+?)&lt;/"+i+"&gt;","gi"),"<"+i+"$1>$2</"+i+">"):o.replace(new RegExp("&lt;"+i+"&gt;((?!&lt;/"+i+"&gt;).+?)&lt;/"+i+"&gt;","gi"),"<"+i+">$1</"+i+">")}}return o},this.unescape=function(e){var t=e.replace(/</g,"&lt;").replace(/>/g,"&gt;");return t=$("<div/>").html(t).text()},this.getSelection=function(){var e=void 0;return window.getSelection&&(sel=window.getSelection(),sel.getRangeAt&&sel.rangeCount&&(e=sel.getRangeAt(0),0===$(e.startContainer).parents(".concord-node:first").length&&(e=void 0))),e},this.saveSelection=function(){var e=this.getSelection();return void 0!==e&&t.op.getCursor().data("range",e.cloneRange()),e},this.restoreSelection=function(e){var o=t.op.getCursor();if(void 0===e&&(e=o.data("range")),void 0!==e&&window.getSelection){o.children(".concord-wrapper").children(".concord-text");try{var n=e.cloneRange(),r=window.getSelection();r.removeAllRanges(),r.addRange(n)}catch(i){console.log(i)}finally{o.removeData("range")}}return e},this.recalculateLevels=function(t){t||(t=e.find(".concord-node")),t.each(function(){var e=$(this).children(".concord-wrapper").children(".concord-text"),t=$(this).attr("class").match(/.*concord-level-(\d+).*/);t&&($(this).removeClass("concord-level-"+t[1]),e.removeClass("concord-level-"+t[1]+"-text"));var o=$(this).parents(".concord-node").length+1;$(this).addClass("concord-level-"+o),e.addClass("concord-level-"+o+"-text")})}}function ConcordOp(root,concordInstance,_cursor){this._walk_up=function(e){var t=e.prev();if(0===t.length){var o=e.parents(".concord-node:first");return 1==o.length?o:null}return this._last_child(t)},this._walk_down=function(e){var t=e.next();if(1==t.length)return t;var o=e.parents(".concord-node:first");return 1==o.length?this._walk_down(o):null},this._last_child=function(e){if(e.hasClass("collapsed"))return e;var t=e.children("ol");if(0===t.length)return e;var o=t.children(".concord-node:last");return 1==o.length?this._last_child(o):e},this.bold=function(){this.saveState(),this.inTextMode()?document.execCommand("bold"):(this.focusCursor(),document.execCommand("selectAll"),document.execCommand("bold"),document.execCommand("unselect"),this.blurCursor(),concordInstance.pasteBinFocus()),this.markChanged()},this.changed=function(){return root.data("changed")===!0},this.clearChanged=function(){return root.data("changed",!1),!0},this.collapse=function(e){void 0===e&&(e=!0);var t=this.getCursor();1==t.length&&(e&&concordInstance.fireCallback("opCollapse",this.setCursorContext(t)),t.addClass("collapsed"),t.find("ol").each(function(){$(this).children().length>0&&$(this).parent().addClass("collapsed")}),this.markChanged())},this.copy=function(){this.inTextMode()||root.data("clipboard",root.find(".selected").clone(!0,!0))},this.countSubs=function(){var e=this.getCursor();return 1==e.length?e.children("ol").children().size():0},this.cursorToXml=function(){return concordInstance.editor.opml(this.getCursor())},this.cursorToXmlSubsOnly=function(){return concordInstance.editor.opml(this.getCursor(),!0)},this.cut=function(){this.inTextMode()||(this.copy(),this.deleteLine())},this.deleteLine=function(){this.saveState();var e;if(this.inTextMode()){var t=this.getCursor();e=t.prev(),0===e.length&&(e=t.parents(".concord-node:first")),t.remove(),1==e.length?this.setCursor(e):1==root.find(".concord-node:first").length?this.setCursor(root.find(".concord-node:first")):this.wipe()}else{var o=root.find(".selected");if(1==o.length)e=o.prev(),0===e.length&&(e=o.parents(".concord-node:first")),o.remove(),1==e.length?this.setCursor(e):1==root.find(".concord-node:first").length?this.setCursor(root.find(".concord-node:first")):this.wipe();else if(o.length>1){var n=root.find(".selected:first");e=n.prev(),0===e.length&&(e=n.parents(".concord-node:first")),o.each(function(){$(this).remove()}),1==e.length?this.setCursor(e):1==root.find(".concord-node:first").length?this.setCursor(root.find(".concord-node:first")):this.wipe()}}if(0===root.find(".concord-node").length){var r=this.insert("",down);this.setCursor(r)}this.markChanged()},this.deleteSubs=function(){var e=this.getCursor();1==e.length&&e.children("ol").children().length>0&&(this.saveState(),e.children("ol").empty()),this.markChanged()},this.demote=function(){var e=this.getCursor();e.nextAll().length>0&&(this.saveState(),e.nextAll().each(function(){var t=$(this).clone(!0,!0);$(this).remove(),t.appendTo(e.children("ol")),e.removeClass("collapsed")}),concordInstance.editor.recalculateLevels(e.find(".concord-node")),this.markChanged())},this.expand=function(e){void 0===e&&(e=!0);var t=this.getCursor();if(1==t.length){if(e&&concordInstance.fireCallback("opExpand",this.setCursorContext(t)),!t.hasClass("collapsed"))return;t.removeClass("collapsed");var o=t.offset().top,n=t.height(),r=$(window).scrollTop(),i=$(window).height();if(r>o||o+n>r+i)if(r>o)$(window).scrollTop(o);else if(o+n>r+i){var s=parseInt(t.children(".concord-wrapper").children(".concord-text").css("line-height"))+6;i>n+s?$(window).scrollTop(o-(i-n)+s):$(window).scrollTop(o)}this.markChanged()}},this.expandAllLevels=function(){var e=this.getCursor();1==e.length&&(e.removeClass("collapsed"),e.find(".concord-node").removeClass("collapsed"))},this.focusCursor=function(){this.getCursor().children(".concord-wrapper").children(".concord-text").focus()},this.blurCursor=function(){this.getCursor().children(".concord-wrapper").children(".concord-text").blur()},this.fullCollapse=function(){root.find(".concord-node").each(function(){$(this).children("ol").children().size()>0&&$(this).addClass("collapsed")});var e=this.getCursor(),t=e.parents(".concord-node:last");1==t.length&&concordInstance.editor.select(t)},this.fullExpand=function(){root.find(".concord-node").removeClass("collapsed")},this.getCursor=function(){return _cursor?_cursor:root.find(".concord-cursor:first")},this.getCursorRef=function(){return this.setCursorContext(this.getCursor())},this.getHeaders=function(){var e={};return root.data("head")&&(e=root.data("head")),e.title=this.getTitle(),e},this.getLineText=function(){var e=this.getCursor();if(1==e.length){var t=e.children(".concord-wrapper:first").children(".concord-text:first").html(),o=t.match(/^(.+)<br>\s*$/);return o&&(t=o[1]),concordInstance.editor.unescape(t)}return null},this.getRenderMode=function(){return void 0!==root.data("renderMode")?root.data("renderMode")===!0:!0},this.getTitle=function(){return root.data("title")},this.go=function(e,t,o,n){void 0===t&&(t=1);var r=this.getCursor();void 0===n&&(n=!1),this.setTextMode(n);var i,s,a,c,d=!1;switch(e){case up:for(i=0;t>i&&(c=r.prev(),1==c.length);i++)r=c,d=!0;this.setCursor(r,o);break;case down:for(i=0;t>i&&(a=r.next(),1==a.length);i++)r=a,d=!0;this.setCursor(r,o);break;case left:for(i=0;t>i;i++){var l=r.parents(".concord-node:first");if(1!=l.length)break;r=l,d=!0}this.setCursor(r,o);break;case right:for(i=0;t>i;i++){var h=r.children("ol").children(".concord-node:first");if(1!=h.length)break;r=h,d=!0}this.setCursor(r,o);break;case flatup:for(s=0;r&&t>s;)if(r=this._walk_up(r),r&&!r.hasClass("collapsed")&&r.children("ol").children().size()>0&&(s++,d=!0,s==t)){this.setCursor(r,o);break}break;case flatdown:for(s=0;r&&t>s;){if(a=null,!r.hasClass("collapsed")){var u=r.children("ol");if(1==u.length){var p=u.children(".concord-node:first");1==p.length&&(a=p)}}a||(a=this._walk_down(r)),r=a,r&&!r.hasClass("collapsed")&&r.children("ol").children().size()>0&&(s++,d=!0,s==t&&this.setCursor(r,o))}}return this.markChanged(),d},this.insert=function(e,t){this.saveState();var o=this.getCursor().parents(".concord-node").length+1,n=$("<li></li>");switch(n.addClass("concord-node"),t){case right:o+=1;break;case left:o-=1}n.addClass("concord-level-"+o);var r=$("<div class='concord-wrapper'></div>"),i="caret-right",s='<i class="node-icon fa fa-'+i+'"></i>';r.append(s),r.addClass("type-icon");var a=$("<div class='concord-text' contenteditable='true'></div>");a.addClass("concord-level-"+o+"-text");var c=$("<ol></ol>");a.appendTo(r),r.appendTo(n),c.appendTo(n),e&&""!==e&&a.html(concordInstance.editor.escape(e));var d=this.getCursor();switch(t||(t=down),t){case down:d.after(n);break;case right:d.children("ol").prepend(n),this.expand(!1);break;case up:d.before(n);break;case left:var l=d.parents(".concord-node:first");1==l.length&&l.after(n)}return this.setCursor(n),this.markChanged(),concordInstance.fireCallback("opInsert",this.setCursorContext(n)),n},this.insertImage=function(e){this.inTextMode()?document.execCommand("insertImage",null,e):this.insert('<img src="'+e+'">',down)},this.insertText=function(e){var t,o,n=$("<ol></ol>"),r=0,i=0,s=0,a=null,c=null,d={},l=e.split("\n"),h=!0,u=null,p=0;for(t=0;t<l.length;t++)if(o=l[t],!o.match(/^\s*$/)){p=t;break}for(l.length>p+2&&null===l[p].match(/^([\t\s]*)\-.*$/)&&l[p].match(/^.+$/)&&""===l[p+1]&&(i=p+2,u=concordInstance.editor.makeNode(),u.children(".concord-wrapper").children(".concord-text").html(l[p])),t=i;t<l.length;t++)if(o=l[t],""!==o&&!o.match(/^\s+$/)&&null===o.match(/^([\t\s]*)\-.*$/)){h=!1;break}for(h||(i=0,u=null),t=i;t<l.length;t++)if(o=l[t],""!==o&&!o.match(/^\s+$/)){var f=o.match(/^([\t\s]*)(.+)$/),v=concordInstance.editor.makeNode(),g=concordInstance.editor.escape(f[2]);if(h){var m=g.match(/^([\t\s]*)\-\s*(.+)$/);null!==m&&(g=m[2])}v.children(".concord-wrapper").children(".concord-text").html(g);var C=s;f[1]&&(C=h?f[1].length/2+s:f[1].length+s,C>r?(d[r]=a,c=a):C>0&&r>C&&(c=d[C-1])),c&&C>0?(c.children("ol").append(v),c.addClass("collapsed")):(d={},n.append(v)),a=v,r=C}if(u){n.children().length>0&&u.addClass("collapsed");var x=n.clone();x.children().appendTo(u.children("ol")),n=$("<ol></ol>"),n.append(u)}if(n.children().length>0){this.saveState(),this.setTextMode(!1);var b=this.getCursor();n.children().insertAfter(b),this.setCursor(b.next()),concordInstance.root.removeData("clipboard"),this.markChanged(),concordInstance.editor.recalculateLevels()}},this.insertXml=function(e,t){this.saveState();var o=null,n=$("<ol></ol>"),r=this.getCursor(),i=r.parents(".concord-node").length+1;switch(t||(t=down),t){case right:i+=1;break;case left:i-=1}o=$("string"==typeof e?$.parseXML(e):e),o.find("body").children("outline").each(function(){n.append(concordInstance.editor.build($(this),!0,i))});var s=o.find("expansionState");if(s&&s.text()&&""!==s.text()){var a=s.text().split(","),c=1;n.find(".concord-node").each(function(){a.indexOf(""+c)>=0&&$(this).removeClass("collapsed"),c++})}switch(t){case down:n.children().insertAfter(r);break;case right:n.children().prependTo(r.children("ol")),this.expand(!1);break;case up:n.children().insertBefore(r);break;case left:var d=r.parents(".concord-node:first");1==d.length&&n.children().insertAfter(d)}return this.markChanged(),!0},this.inTextMode=function(){return root.hasClass("textMode")},this.italic=function(){this.saveState(),this.inTextMode()?document.execCommand("italic"):(this.focusCursor(),document.execCommand("selectAll"),document.execCommand("italic"),document.execCommand("unselect"),this.blurCursor(),concordInstance.pasteBinFocus()),this.markChanged()},this.level=function(){return this.getCursor().parents(".concord-node").length+1},this.link=function(e){if(this.inTextMode()){if(!concord.handleEvents){var t=this;return void concord.onResume(function(){t.link(e)})}var o=concordInstance.editor.getSelection();void 0===o&&concordInstance.editor.restoreSelection(),concordInstance.editor.getSelection()&&(this.saveState(),document.execCommand("createLink",null,e),this.markChanged())}},this.markChanged=function(){return root.data("changed",!0),this.inTextMode()||root.find(".concord-node.dirty").removeClass("dirty"),!0},this.paste=function(){if(!this.inTextMode()&&null!==root.data("clipboard")){var e=root.data("clipboard").clone(!0,!0);e.length>0&&(this.saveState(),root.find(".selected").removeClass("selected"),e.insertAfter(this.getCursor()),this.setCursor($(e[0]),e.length>1),this.markChanged())}},this.promote=function(){var e=this.getCursor();e.children("ol").children().length>0&&(this.saveState(),e.children("ol").children().reverse().each(function(){var t=$(this).clone(!0,!0);$(this).remove(),e.after(t)}),concordInstance.editor.recalculateLevels(e.parent().find(".concord-node")),this.markChanged())},this.redraw=function(){var e=1,t=1,o=this.changed();root.find(".concord-node:visible").each(function(){return $(this).hasClass("concord-cursor")?(t=e,!1):void e++}),this.xmlToOutline(this.outlineToXml()),e=1;var n=this;root.find(".concord-node:visible").each(function(){return t==e?(n.setCursor($(this)),!1):void e++}),o&&this.markChanged()},this.reorg=function(e,t){void 0===t&&(t=1);var o=!1,n=this.getCursor(),r=this.getCursor(),i=root.find(".selected"),s=1;i.length>1&&(n=root.find(".selected:first"),r=root.find(".selected"));var a,c;switch(e){case up:if(c=n.prev(),1==c.length){for(;t>s&&1==c.prev().length;)c=c.prev(),s++;this.saveState(),a=r.clone(!0,!0),r.remove(),a.insertBefore(c),o=!0}break;case down:this.inTextMode()||(n=root.find(".selected:last"));var d=n.next();if(1==d.length){for(;t>s&&1==d.next().length;)d=d.next(),s++;this.saveState(),a=r.clone(!0,!0),r.remove(),a.insertAfter(d),o=!0}break;case left:var l=n.parent();if(!l.hasClass("concord-root")){for(var h=l.parent();t>s;){var u=h.parents(".concord-node:first");if(1!=u.length)break;h=u,s++}this.saveState(),a=r.clone(!0,!0),r.remove(),a.insertAfter(h),concordInstance.editor.recalculateLevels(h.nextAll(".concord-node")),o=!0}break;case right:if(c=n.prev(),1==c.length){for(this.saveState();t>s&&1==c.children("ol").length;){var p=c.children("ol").children(".concord-node:last");if(1!=p.length)break;c=p,s++}var f=c.children("ol");0===f.length&&(f=$("<ol></ol>"),f.appendTo(c)),a=r.clone(!0,!0),r.remove(),a.appendTo(f),c.removeClass("collapsed"),concordInstance.editor.recalculateLevels(c.find(".concord-node")),o=!0}}return o&&(this.inTextMode()&&this.setCursor(this.getCursor()),this.markChanged()),o},this.runSelection=function(){var value=eval(this.getLineText());this.deleteSubs(),this.insert(value,"right"),concordInstance.script.makeComment(),this.go("left",1)},this.saveState=function(){if(root.data("change",root.children().clone(!0,!0)),root.data("changeTextMode",this.inTextMode()),this.inTextMode()){var e=concordInstance.editor.getSelection();e?root.data("changeRange",e.cloneRange()):root.data("changeRange",void 0)}else root.data("changeRange",void 0);return!0},this.setCursor=function(e,t,o){root.find(".concord-cursor").removeClass("concord-cursor"),e.addClass("concord-cursor"),this.inTextMode()?concordInstance.editor.edit(e):(concordInstance.editor.select(e,t,o),concordInstance.pasteBinFocus()),concordInstance.fireCallback("opCursorMoved",this.setCursorContext(e)),concordInstance.editor.hideContextMenu()},this.setCursorContext=function(e){return new ConcordOp(root,concordInstance,e)},this.setHeaders=function(e){root.data("head",e),this.markChanged()},this.setLineText=function(e){this.saveState();var t=this.getCursor();return 1==t.length?(t.children(".concord-wrapper:first").children(".concord-text:first").html(concordInstance.editor.escape(e)),!0):!1},this.setRenderMode=function(e){
return root.data("renderMode",e),this.redraw(),!0},this.setStyle=function(e){return root.parent().find("style.customStyle").remove(),root.before('<style type="text/css" class="customStyle">'+e+"</style>"),!0},this.setTextMode=function(e){var t=concordInstance.prefs().readonly;void 0===t&&(t=!1),t||root.hasClass("textMode")!=e&&(e===!0?(root.addClass("textMode"),concordInstance.editor.editorMode(),concordInstance.editor.edit(this.getCursor())):(root.removeClass("textMode"),root.find(".editing").removeClass("editing"),this.blurCursor(),concordInstance.editor.select(this.getCursor())))},this.setTitle=function(e){return root.data("title",e),!0},this.setId=function(e){return root.data("id",e.replace(new RegExp(" ","g"),"_")),!0},this.strikethrough=function(){this.saveState(),this.inTextMode()?document.execCommand("strikeThrough"):(this.focusCursor(),document.execCommand("selectAll"),document.execCommand("strikeThrough"),document.execCommand("unselect"),this.blurCursor(),concordInstance.pasteBinFocus()),this.markChanged()},this.subsExpanded=function(){var e=this.getCursor();return 1==e.length&&!e.hasClass("collapsed")&&e.children("ol").children().size()>0?!0:!1},this.outlineToText=function(){var e="";return root.children(".concord-node").each(function(){e+=concordInstance.editor.textLine($(this))}),e},this.outlineToXml=function(e,t,o){var n=this.getHeaders();e&&(n.ownerName=e),t&&(n.ownerEmail=t),o&&(n.ownerId=o);var r=this.getTitle();r||(r=""),n.title=r,n.dateModified=(new Date).toGMTString();var i=[],s=1,a=root.find(".concord-node:first");do{if(!a)break;!a.hasClass("collapsed")&&a.children("ol").children().size()>0&&i.push(s),s++;var c=null;if(!a.hasClass("collapsed")){var d=a.children("ol");if(1==d.length){var l=d.children(".concord-node:first");1==l.length&&(c=l)}}c||(c=this._walk_down(a)),a=c}while(null!==a);n.expansionState=i.join(",");var h="",u=0,p=function(e){for(var t=0;u>t;t++)h+="	";h+=e+"\n"};p('<?xml version="1.0" encoding="UTF-8"?>'),p('<opml version="2.0">'),u++,p("<head>"),u++;for(var f in n)void 0!==n[f]&&p("<"+f+">"+ConcordUtil.escapeXml(n[f])+"</"+f+">");return u--,p("</head>"),p("<body>"),u++,root.children(".concord-node").each(function(){h+=concordInstance.editor.opmlLine($(this),u)}),u--,p("</body>"),u--,p("</opml>"),h},this.undo=function(){var e,t=root.children().clone(!0,!0),o=this.inTextMode(),n=void 0;return this.inTextMode()&&(e=concordInstance.editor.getSelection(),e&&(n=e.cloneRange())),root.data("change")?(root.empty(),root.data("change").appendTo(root),this.setTextMode(root.data("changeTextMode")),this.inTextMode()&&(this.focusCursor(),e=root.data("changeRange"),e&&concordInstance.editor.restoreSelection(e)),root.data("change",t),root.data("changeTextMode",o),root.data("changeRange",n),!0):!1},this.visitLevel=function(e){var t=this.getCursor(),o=this;return t.children("ol").children().each(function(){var t=o.setCursorContext($(this));e(t)}),!0},this.visitToSummit=function(e){for(var t=this.getCursor();e(this.setCursorContext(t));){var o=t.parents(".concord-node:first");if(1!=o.length)break;t=o}return!0},this.visitAll=function(e){var t=this;root.find(".concord-node").each(function(){var o=t.setCursorContext($(this)),n=e(o);return void 0!==n&&n===!1?!1:void 0})},this.wipe=function(){root.find(".concord-node").length>0&&this.saveState(),root.empty();var e=concordInstance.editor.makeNode();root.append(e),this.setTextMode(!1),this.setCursor(e),this.markChanged()},this.xmlToOutline=function(e,t){void 0===t&&(t=!0);var o=null;o=$("string"==typeof e?$.parseXML(e):e),root.empty();var n="";1==o.find("title:first").length&&(n=o.find("title:first").text()),this.setTitle(n);var r={};o.find("head").children().each(function(){r[$(this).prop("tagName")]=$(this).text()}),root.data("head",r),o.find("body").children("outline").each(function(){root.append(concordInstance.editor.build($(this),!0))}),root.data("changed",!1),root.removeData("previousChange");var i=o.find("expansionState");if(i&&i.text()&&""!==i.text()){var s=i.text().split(/\s*,\s*/),a=1,c=root.find(".concord-node:first");do{if(!c)break;s.indexOf(""+a)>=0&&c.removeClass("collapsed"),a++;var d=null;if(!c.hasClass("collapsed")){var l=c.children("ol");if(1==l.length){var h=l.children(".concord-node:first");1==h.length&&(d=h)}}d||(d=this._walk_down(c)),c=d}while(null!==c)}return this.setTextMode(!1),t&&this.setCursor(root.find(".concord-node:first")),root.data("currentChange",root.children().clone(!0,!0)),!0},this.attributes=new ConcordOpAttributes(concordInstance,this.getCursor())}function ConcordOpAttributes(e,t){this._cssTextClassName="cssTextClass",this._cssTextClass=function(e){if(void 0!==e){var o=e.split(/\s+/),n=t.children(".concord-wrapper:first").children(".concord-text:first"),r=n.attr("class");if(r){var i=r.split(/\s+/);for(var s in i){var a=i[s];null===a.match(/^concord\-.+$/)&&n.removeClass(a)}}for(var c in o){var d=o[c];n.addClass(d)}}},this.addGroup=function(o){o.type?t.attr("opml-type",o.type):t.removeAttr("opml-type"),this._cssTextClass(o[this._cssTextClassName]);var n=this.getAll(),r="type";o.icon&&(r="icon");for(var i in o)if(n[i]=o[i],i==r){var s=o[i],a=t.children(".concord-wrapper"),c=null;if("type"==i&&e.prefs()&&e.prefs().typeIcons&&e.prefs().typeIcons[s]?c=e.prefs().typeIcons[s]:"icon"==i&&(c=s),c){var d='<i class="node-icon fa fa-'+c+'"></i>';a.children(".node-icon:first").replaceWith(d)}}return t.data("attributes",n),e.op.markChanged(),n},this.setGroup=function(o){void 0!==o[this._cssTextClassName]?this._cssTextClass(o[this._cssTextClassName]):this._cssTextClass(""),t.data("attributes",o);var n=t.children(".concord-wrapper");$(t[0].attributes).each(function(){var e=this.name.match(/^opml-(.+)$/);if(e){var n=e[1];o[n]||t.removeAttr(this.name)}});var r="type";o.icon&&(r="icon"),"type"==i&&t.attr("opml-"+i,o[i]);for(var i in o)if(i==r){var s=o[i];n=t.children(".concord-wrapper");var a=null;if("type"==i&&e.prefs()&&e.prefs().typeIcons&&e.prefs().typeIcons[s]?a=e.prefs().typeIcons[s]:"icon"==i&&(a=s),a){var c='<i class="node-icon fa fa-'+a+'"></i>';n.children(".node-icon:first").replaceWith(c)}}return e.op.markChanged(),o},this.getAll=function(){return void 0!==t.data("attributes")?t.data("attributes"):{}},this.getOne=function(e){return this.getAll()[e]},this.makeEmpty=function(){this._cssTextClass("");var o=0,n=this.getAll();if(void 0!==n)for(var r in n)o++;t.removeData("attributes");var i=o>0;return $(t[0].attributes).each(function(){var e=this.name.match(/^opml-(.+)$/);e&&t.removeAttr(this.name)}),i&&e.op.markChanged(),i},this.setOne=function(o,n){o==this._cssTextClassName&&this._cssTextClass(n);var r=this.getAll();if(r[o]=n,t.data("attributes",r),"type"==o||"icon"==o){t.attr("opml-"+o,n);var i=t.children(".concord-wrapper"),s=null;if("type"==o&&e.prefs()&&e.prefs().typeIcons&&e.prefs().typeIcons[n]?s=e.prefs().typeIcons[n]:"icon"==o&&(s=n),s){var a='<i class="node-icon fa fa-'+s+'"></i>';i.children(".node-icon:first").replaceWith(a)}}return e.op.markChanged(),!0},this.exists=function(e){return void 0!==this.getOne(e)?!0:!1},this.removeOne=function(t){return this.getAll()[t]?(t==this._cssTextClassName&&this._cssTextClass(""),delete this.getAll()[t],e.op.markChanged(),!0):!1}}function ConcordScript(e,t){this.isComment=function(){if(void 0!==t.op.attributes.getOne("isComment"))return"true"==t.op.attributes.getOne("isComment");var e=!1;return t.op.getCursor().parents(".concord-node").each(function(){return"true"==t.op.setCursorContext($(this)).attributes.getOne("isComment")?void(e=!0):void 0}),e},this.makeComment=function(){return t.op.attributes.setOne("isComment","true"),t.op.getCursor().addClass("concord-comment"),!0},this.unComment=function(){return t.op.attributes.setOne("isComment","false"),t.op.getCursor().removeClass("concord-comment"),!0}}function ConcordEvents(e,t,o,n){var r=this;this.wrapperDoubleClick=function(n){if(concord.handleEvents){if(e.data("dropdown"))return void t.hideContextMenu();if(!t.editable($(n.target))){var r=$(n.target);if(r.hasClass("node-icon")&&(r=r.parent()),r.hasClass("concord-wrapper")){n.stopPropagation();r.parents(".concord-node:first");o.setTextMode(!1),o.subsExpanded()?o.collapse():o.expand()}}}},this.clickSelect=function(i){var s;if(concord.handleEvents){if(e.data("dropdown"))return i.stopPropagation(),void t.hideContextMenu();if(concord.mobile&&(s=$(i.target),n.op.getCursor()[0]===s[0]))return void r.doubleClick(i);if(1==i.which&&!t.editable($(i.target))){if(s=$(i.target),!s.hasClass("concord-node"))return;if(1==s.length){if(i.stopPropagation(),i.shiftKey&&s.parents(".concord-node.selected").length>0)return;o.setTextMode(!1),o.setCursor(s,i.shiftKey||i.metaKey,i.shiftKey)}}}},this.doubleClick=function(n){if(concord.handleEvents){if(e.data("dropdown"))return void t.hideContextMenu();if(!t.editable($(n.target))){var r=$(n.target);r.hasClass("concord-node")&&r.hasClass("concord-cursor")&&(n.stopPropagation(),o.setTextMode(!1),o.setCursor(r),o.subsExpanded()?o.collapse():o.expand())}}},this.wrapperClickSelect=function(i){var s;if(concord.handleEvents){if(e.data("dropdown"))return void t.hideContextMenu();if(concord.mobile){var a=$(i.target);if(s=a.parents(".concord-node:first"),n.op.getCursor()[0]===s[0])return void r.wrapperDoubleClick(i)}if(1==i.which&&!t.editable($(i.target))){var c=$(i.target);if(c.hasClass("node-icon")&&(c=c.parent()),c.hasClass("concord-wrapper")){if(s=c.parents(".concord-node:first"),i.shiftKey&&s.parents(".concord-node.selected").length>0)return;o.setTextMode(!1),o.setCursor(s,i.shiftKey||i.metaKey,i.shiftKey)}}}},this.contextmenu=function(e){if(concord.handleEvents){e.preventDefault(),e.stopPropagation();var r=$(e.target);(r.hasClass("concord-wrapper")||r.hasClass("node-icon"))&&o.setTextMode(!1),r.hasClass("concord-node")||(r=r.parents(".concord-node:first")),n.fireCallback("opContextMenu",o.setCursorContext(r)),o.setCursor(r),t.showContextMenu(e.pageX,e.pageY)}},e.on("dblclick",".concord-wrapper",this.wrapperDoubleClick),e.on("dblclick",".concord-node",this.doubleClick),e.on("dblclick",".concord-text",function(e){if(concord.handleEvents&&n.prefs().readonly===!0){e.preventDefault(),e.stopPropagation();var t=$(e.target).parents(".concord-node:first");o.setCursor(t),o.subsExpanded()?o.collapse():o.expand()}}),e.on("click",".concord-wrapper",this.wrapperClickSelect),e.on("click",".concord-node",this.clickSelect),e.on("mouseover",".concord-wrapper",function(e){if(concord.handleEvents){var t=$(e.target).parents(".concord-node:first");n.fireCallback("opHover",o.setCursorContext(t))}}),n.prefs.contextMenu&&(e.on("contextmenu",".concord-text",this.contextmenu),e.on("contextmenu",".concord-node",this.contextmenu),e.on("contextmenu",".concord-wrapper",this.contextmenu)),e.on("blur",".concord-text",function(e){if(concord.handleEvents&&n.prefs().readonly!==!0){$(this).html().match(/^\s*<br>\s*$/)&&$(this).html("");var o=($(this),$(this).parents(".concord-node:first"));n.op.inTextMode()&&t.saveSelection(),n.op.inTextMode()&&o.hasClass("dirty")&&o.removeClass("dirty")}}),e.on("paste",".concord-text",function(e){concord.handleEvents&&n.prefs().readonly!==!0&&($(this).addClass("paste"),n.editor.saveSelection(),n.pasteBin.html(""),n.pasteBin.focus(),setTimeout(t.sanitize,10))}),n.pasteBin.on("copy",function(){if(concord.handleEvents){var t="";e.find(".selected").each(function(){t+=n.editor.textLine($(this))}),""!==t&&"\n"!=t&&(concordClipboard={text:t,data:e.find(".selected").clone(!0,!0)},n.pasteBin.html("<pre>"+$("<div/>").text(t).html()+"</pre>"),n.pasteBin.focus(),document.execCommand("selectAll"))}}),n.pasteBin.on("paste",function(e){if(concord.handleEvents&&n.prefs().readonly!==!0){var o=n.op.getCursor().children(".concord-wrapper").children(".concord-text");o.addClass("paste"),n.pasteBin.html(""),setTimeout(t.sanitize,10)}}),n.pasteBin.on("cut",function(){if(concord.handleEvents&&n.prefs().readonly!==!0){var t="";e.find(".selected").each(function(){t+=n.editor.textLine($(this))}),""!==t&&"\n"!=t&&(concordClipboard={text:t,data:e.find(".selected").clone(!0,!0)},n.pasteBin.html("<pre>"+$("<div/>").text(t).html()+"</pre>"),n.pasteBinFocus()),n.op.deleteLine(),setTimeout(function(){n.pasteBinFocus()},200)}}),e.on("mousedown",function(r){if(concord.handleEvents){var i,s=$(r.target);if(s.is("a"))return void(s.attr("href")&&(r.preventDefault(),window.open(s.attr("href"))));if(n.prefs().readonly===!0)return r.preventDefault(),s=$(r.target),1==s.parents(".concord-text:first").length&&(s=s.parents(".concord-text:first")),void(s.hasClass("concord-text")&&(i=s.parents(".concord-node:first"),1==i.length&&o.setCursor(i)));if(1==r.which){if(e.data("dropdown"))return void t.hideContextMenu();1==s.parents(".concord-text:first").length&&(s=s.parents(".concord-text:first")),s.hasClass("concord-text")?(i=s.parents(".concord-node:first"),1==i.length&&(e.hasClass("textMode")||(e.find(".selected").removeClass("selected"),e.addClass("textMode")),i.children(".concord-wrapper").children(".concord-text").hasClass("editing")&&(e.find(".editing").removeClass("editing"),i.children(".concord-wrapper").children(".concord-text").addClass("editing")),i.hasClass("concord-cursor")||(e.find(".concord-cursor").removeClass("concord-cursor"),i.addClass("concord-cursor"),n.fireCallback("opCursorMoved",o.setCursorContext(i))))):(r.preventDefault(),e.data("mousedown",!0))}}}),e.on("mousemove",function(o){if(concord.handleEvents&&n.prefs().readonly!==!0&&!t.editable($(o.target))&&(o.preventDefault(),e.data("mousedown")&&!e.data("dragging"))){var r=$(o.target);r.hasClass("node-icon")&&(r=r.parent()),r.hasClass("concord-wrapper")&&r.parent().hasClass("selected")&&t.dragMode()}}),e.on("mouseup",function(o){if(concord.handleEvents&&n.prefs().readonly!==!0){var r=$(o.target);if(r.hasClass("concord-node")?r=r.children(".concord-wrapper:first").children(".concord-text:first"):r.hasClass("concord-wrapper")&&(r=r.children(".concord-text:first")),!t.editable(r)&&(e.data("mousedown",!1),e.data("dragging"))){r=$(o.target);var i=r.parents(".concord-node:first"),s=e.find(".selected");if(1==i.length&&s.length>=1){var a=!1;s.each(function(){this==i[0]&&(a=!0)});var c,d;if(a){var l=i.prev();1==l.length&&l.hasClass("drop-child")&&(c=s.clone(!0,!0),d=l.children("ol"),c.appendTo(d),l.removeClass("collapsed"),s.remove())}else{var h=!1;i.parents(".concord-node").each(function(){var e=$(this)[0];s.each(function(){$(this)[0]==e&&(h=!0)})}),h||(r.hasClass("concord-wrapper")||r.hasClass("node-icon")?(c=s.clone(!0,!0),c.insertAfter(i),s.remove()):(c=s.clone(!0,!0),d=i.children("ol"),c.prependTo(d),i.removeClass("collapsed"),s.remove()))}}t.dragModeExit(),n.editor.recalculateLevels()}}}),e.on("mouseover",function(t){if(concord.handleEvents&&n.prefs().readonly!==!0&&e.data("dragging")){t.preventDefault();var o=$(t.target),r=o.parents(".concord-node:first"),i=e.find(".selected");if(1==r.length&&i.length>=1){var s=!1;if(i.each(function(){this==r[0]&&(s=!0)}),s){if(1==i.length){var a=r.prev();1==a.length&&(a.removeClass("drop-sibling").remove("drop-child"),a.addClass("drop-child"))}}else{var c=!1;r.parents(".concord-node").each(function(){var e=$(this)[0];i.each(function(){$(this)[0]==e&&(c=!0)})}),c||(r.removeClass("drop-sibling").remove("drop-child"),o.hasClass("concord-wrapper")||o.hasClass("node-icon")?r.addClass("drop-sibling"):r.addClass("drop-child"))}}}}),e.on("mouseout",function(t){concord.handleEvents&&n.prefs().readonly!==!0&&e.data("dragging")&&(e.find(".drop-sibling").removeClass("drop-sibling"),e.find(".drop-child").removeClass("drop-child"))})}function Op(e){var t=$("<div></div>");return t.concord().op.xmlToOutline(e),t.concord().op}void 0!==$.fn.tooltip&&$("a[rel=tooltip]").tooltip({live:!0}),void 0!==$.fn.popover&&$("a[rel=popover]").on("mouseenter mouseleave",function(){$(this).popover("toggle")});var concord={version:"2.49",mobile:/Android|webOS|iPhone|iPad|iPod|BlackBerry/i.test(navigator.userAgent),ready:!1,handleEvents:!0,resumeCallbacks:[],onResume:function(e){this.resumeCallbacks.push(e)},resumeListening:function(){if(!this.handleEvents){this.handleEvents=!0;var e=this.getFocusRoot();if(null!==e){var t=new ConcordOutline(e.parent());t.op.inTextMode()?(t.op.focusCursor(),t.editor.restoreSelection()):t.pasteBinFocus();for(var o in this.resumeCallbacks){var n=this.resumeCallbacks[o];n()}this.resumeCallbacks=[]}}},stopListening:function(){if(this.handleEvents){this.handleEvents=!1;var e=this.getFocusRoot();if(null!==e){var t=new ConcordOutline(e.parent());t.op.inTextMode()&&t.editor.saveSelection()}}},focusRoot:null,getFocusRoot:function(){return 1==$(".concord-root:visible").length?this.setFocusRoot($(".concord-root:visible:first")):$(".modal").is(":visible")&&1==$(".modal").find(".concord-root:visible:first").length?this.setFocusRoot($(".modal").find(".concord-root:visible:first")):null===this.focusRoot?$(".concord-root:visible").length>0?this.setFocusRoot($(".concord-root:visible:first")):null:this.focusRoot.is(":visible")?this.focusRoot:this.setFocusRoot($(".concord-root:visible:first"))},setFocusRoot:function(e){var t=this.focusRoot,o=new ConcordOutline(e.parent());if(null!==t&&t[0]!==e[0]){var n=new ConcordOutline(t.parent());n.editor.hideContextMenu(),n.editor.dragModeExit(),o.op.inTextMode()?o.op.focusCursor():o.pasteBinFocus()}return this.focusRoot=e,this.focusRoot},updateFocusRootEvent:function(e){var t=$(e.target).parents(".concord-root:first");1==t.length&&concord.setFocusRoot(t)}},concordEnvironment={version:concord.version},concordClipboard;jQuery.fn.reverse=[].reverse;var nil=null,infinity=Number.MAX_VALUE,down="down",left="left",right="right",up="up",flatup="flatup",flatdown="flatdown",nodirection="nodirection",XML_CHAR_MAP={"<":"&lt;",">":"&gt;","&":"&amp;",'"':"&quot;"},ConcordUtil={escapeXml:function(e){e=e.toString(),e=e.replace(/\u00A0/g," ");var t=e.replace(/[<>&"]/g,function(e){return XML_CHAR_MAP[e]});return t}};$.fn.concord=function(e){return new ConcordOutline($(this),e)},$(document).on("keydown",function(e){if(concord.handleEvents&&!$(e.target).is("input")&&!$(e.target).is("textarea")){var t=concord.getFocusRoot();if(null!==t){var o=t;o.data("keydownEvent",e);var n=new ConcordOutline(o.parent()),r=n.prefs().readonly;if(void 0===r&&(r=!1),r&&(e.which>=37&&e.which<=40?r=!1:(e.metaKey||e.ctrlKey)&&188==e.which&&(r=!1)),!r){n.fireCallback("opKeystroke",e);var i,s,a,c,d,l,h,u=!1,p=e.metaKey||e.ctrlKey;switch(e.which){case 8:concord.mobile?(""===n.op.getLineText()||"<br>"==n.op.getLineText())&&(e.preventDefault(),n.op.deleteLine()):n.op.inTextMode()?n.op.getCursor().hasClass("dirty")||(n.op.saveState(),n.op.getCursor().addClass("dirty")):(u=!0,e.preventDefault(),n.op.deleteLine());break;case 9:u=!0,e.preventDefault(),e.stopPropagation(),e.shiftKey?n.op.reorg(left):n.op.reorg(right);break;case 65:p&&(u=!0,e.preventDefault(),i=n.op.getCursor(),n.op.inTextMode()?(n.op.focusCursor(),document.execCommand("selectAll",!1,null)):(n.editor.selectionMode(),i.parent().children().addClass("selected")));break;case 85:p&&(u=!0,e.preventDefault(),n.op.reorg(up));break;case 68:p&&(u=!0,e.preventDefault(),n.op.reorg(down));break;case 76:p&&(u=!0,e.preventDefault(),n.op.reorg(left));break;case 82:p&&(u=!0,e.preventDefault(),n.op.reorg(right));break;case 219:p&&(u=!0,e.preventDefault(),n.op.promote());break;case 221:p&&(u=!0,e.preventDefault(),n.op.demote());break;case 13:if(concord.mobile){e.preventDefault(),u=!0,i=n.op.getCursor();var f=i.clone(!0,!0);f.removeClass("concord-cursor"),i.removeClass("selected"),i.removeClass("dirty"),i.removeClass("collapsed"),n.op.setLineText("");var v='<i class="node-icon fa fa-caret-right"></i>';i.children(".concord-wrapper").children(".node-icon").replaceWith(v),f.insertBefore(i),n.op.attributes.makeEmpty(),n.op.deleteSubs(),n.op.focusCursor(),n.fireCallback("opInsert",n.op.setCursorContext(i))}else if(e.preventDefault(),u=!0,e.originalEvent&&(e.originalEvent.location&&0!=e.originalEvent.location||e.originalEvent.location&&0!=e.originalEvent.location))n.op.setTextMode(!n.op.inTextMode());else{var g=down;n.op.subsExpanded()&&(g=right),h=n.op.insert("",g),n.op.setTextMode(!0),n.op.focusCursor()}break;case 37:c=!1,$(e.target).hasClass("concord-text")&&e.target.selectionStart>0&&(c=!1),1==o.find(".concord-cursor.selected").length&&(c=!0),c&&(u=!0,e.preventDefault(),i=n.op.getCursor(),s=n.op._walk_up(i),s&&n.op.setCursor(s));break;case 38:u=!0,e.preventDefault(),n.op.inTextMode()?(i=n.op.getCursor(),s=n.op._walk_up(i),s&&n.op.setCursor(s)):n.op.go(up,1,e.shiftKey,n.op.inTextMode());break;case 39:c=!1,1==o.find(".concord-cursor.selected").length&&(c=!0),c&&(u=!0,e.preventDefault(),a=null,i=n.op.getCursor(),i.hasClass("collapsed")||(d=i.children("ol"),1==d.length&&(l=d.children(".concord-node:first"),1==l.length&&(a=l))),a||(a=n.op._walk_down(i)),a&&n.op.setCursor(a));break;case 40:u=!0,e.preventDefault(),n.op.inTextMode()?(a=null,i=n.op.getCursor(),i.hasClass("collapsed")||(d=i.children("ol"),1==d.length&&(l=d.children(".concord-node:first"),1==l.length&&(a=l))),a||(a=n.op._walk_down(i)),a&&n.op.setCursor(a)):n.op.go(down,1,e.shiftKey,n.op.inTextMode());break;case 46:n.op.inTextMode()?n.op.getCursor().hasClass("dirty")||(n.op.saveState(),n.op.getCursor().addClass("dirty")):(u=!0,e.preventDefault(),n.op.deleteLine());break;case 90:break;case 88:p&&n.op.inTextMode()&&(""===n.op.getLineText()?(u=!0,e.preventDefault(),n.op.deleteLine()):n.op.saveState());break;case 67:break;case 86:break;case 220:p&&(n.script.isComment()?n.script.unComment():n.script.makeComment());break;case 73:p&&(u=!0,e.preventDefault(),n.op.italic());break;case 66:p&&(u=!0,e.preventDefault(),n.op.bold());break;case 192:p&&(u=!0,e.preventDefault(),n.op.setRenderMode(!n.op.getRenderMode()));break;case 188:p&&(u=!0,e.preventDefault(),n.op.subsExpanded()?n.op.collapse():n.op.expand());break;case 191:p&&(u=!0,e.preventDefault(),n.op.runSelection());break;default:u=!1}u||(-1!=[33,34,35,36,91,93,45,20,19].indexOf(e.which)||e.which>=112&&e.which<=145?(n.op.inTextMode()||n.op.setTextMode(!0),n.op.markChanged()):(e.which=32)&&e.which<1e3&&!p&&(h=n.op.getCursor(),n.op.inTextMode()?(h.hasClass("dirty")||n.op.saveState(),h.addClass("dirty")):(n.op.setTextMode(!0),n.op.saveState(),n.editor.edit(h,!0),h.addClass("dirty")),n.op.markChanged()))}}}}),$(document).on("mouseup",function(e){if(concord.handleEvents&&0!==$(".concord-root").length&&!($(e.target).is("a")||$(e.target).is("input")||$(e.target).is("textarea")||1==$(e.target).parents("a:first").length||$(e.target).hasClass("dropdown-menu")||$(e.target).parents(".dropdown-menu:first").length>0)){var t=$(e.target).parents(".concord-root:first");if(0===t.length){$(".concord-root").each(function(){var e=new ConcordOutline($(this).parent());e.editor.hideContextMenu(),e.editor.dragModeExit()});concord.getFocusRoot()}}}),$(document).on("click",concord.updateFocusRootEvent),$(document).on("dblclick",concord.updateFocusRootEvent),$(document).on("show",function(e){$(e.target).is(".modal")&&"true"!=$(e.target).attr("concord-events")&&concord.stopListening()}),$(document).on("hidden",function(e){$(e.target).is(".modal")&&"true"!=$(e.target).attr("concord-events")&&concord.resumeListening()}),concord.ready=!0}(jQuery);var appTypeIcons={blogpost:"file-text-alt",code:"laptop",html:"file-text-alt",include:"share-alt",index:"file-text-alt",link:"bookmark-empty",outline:"file-text-alt",photo:"camera",presentation:"file-text-alt",redirect:"refresh",river:"file-text-alt",rss:"rss",tabs:"file-text-alt",thread:"comments",thumblist:"th",profile:"user",calendar:"calendar",markdown:"file-text-alt",tweet:"twitter",metaWeblogPost:"file-text-alt"},initialOpmltext='<?xml version="1.0" encoding="UTF-8"?><opml version="2.0"><head><title>Untitled</title></head><body><outline text=""/></body></opml>',defaultUtilsOutliner="#outliner",readHttpUrl="http://trex.smallpicture.com/ajax/httpReadUrl";!function(e){}(jQuery);